{"version":3,"sources":["nexus/core.cljc"],"mappings":"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","names":["nexus.core/conjv","cljs.core.fnil","cljs.core/conj","nexus.core/intov","cljs.core/into","nexus.core/action?","data","cljs.core/vector?","cljs.core/Keyword","cljs.core/first","nexus.core/actions?","cljs.core/sequential?","cljs.core/every?","p__28860","vec__28861","cljs.core.nth","nexus.core/run-interceptors","ctx","interceptors","before","after","k","f","state","phase","interceptor","e28866","G__28867","cljs.core/ifn?","e","cljs.core.update","cljs.core.into","cljs.core/select-keys","cljs.core.merge","cljs.core/next","invoke","or__5025__auto__","nexus.core/wrap-action-handler","cljs.core.assoc","cljs.core.apply","p__28868","map__28869","cljs.core/--destructure-map","cljs.core.get","nexus.core/interpolate-1","placeholders","dispatch-data","action","interpolated","clojure.walk/postwalk","x","temp__5823__auto__","G__28870","cljs.core.not_EQ_","cljs.core/with-meta","p__28871","p__28872","vec__28873","map__28876","nexus.core/expand-action","nexus","kind","errors","cljs.core.get_in","map__28877","actions","G__28878","cljs.core.conj","cljs.core/vec","cljs.core.partial","acc","G__28879","cljs.core/seq","cljs.core.ex_info","cljs.core._EQ_","G__28880","cljs.core.reduce","res","map__28881","G__28882","G__28883","G__28884","G__28885","G__28886","var_args","args__5755__auto__","len__5749__auto__","i__5750__auto__","argseq__5756__auto__","cljs.core/IndexedSeq","nexus.core/expand-actions","p__28891","vec__28892","seq28887","G__28888","G__28889","G__28890","self__5734__auto__","map__28895","G__28896","nexus.core/interpolate","p1__28897#","cljs.core.mapv","nexus.core/get-batched-effects","cljs.core.filter","cljs.core.comp","cljs.core/meta","cljs.core/val","cljs.core/key","cljs.core/set","nexus.core/wrap-batched-effect-handler","G__28898","G__28899","G__28900","cljs.core.dissoc","nexus.core/wrap-effect-handler","nexus.core/execute-batch","effect-k","effects","wrap-handler","v","G__28901","ret","G__28902","cljs.core/keys","nexus.core/execute","cljs.core/group-by","p__28905","vec__28906","p1__28903#","p2__28904#","nexus.core/dispatch","system","js/Error","dispatch!","p__28909","vec__28910","disp-data","handler","map__28913","nexus.core.expand_actions","G__28914","G__28915","temp__5825__auto__","system->state"],"sourcesContent":["(ns nexus.core\n  (:require [clojure.walk :as walk]))\n\n(def ^:private conjv (fnil conj []))\n(def ^:private intov (fnil into []))\n\n(defn action? [data]\n  (and (vector? data) (keyword? (first data))))\n\n(defn actions? [data]\n  (and (sequential? data) (every? action? data)))\n\n(defn ^{:indent 1 :no-doc true} run-interceptors [ctx interceptors [before after k]]\n  (letfn [(invoke [f state phase interceptor]\n            (try\n              (cond-> state\n                (ifn? f) f)\n              (catch #?(:clj Exception :cljs :default) e\n                (update state :errors conjv\n                        (into {:phase phase\n                               :err e\n                               k (ctx k)}\n                              (select-keys interceptor [:id]))))))]\n    (loop [state (merge ctx {:queue interceptors :stack ()})]\n      (cond\n        (:queue state)\n        (let [interceptor (first (:queue state))\n              state (-> (update state :queue next)\n                        (update :stack conj interceptor))]\n          (recur (invoke (before interceptor) state (or (:phase interceptor) before) interceptor)))\n\n        (:stack state)\n        (let [interceptor (first (:stack state))\n              state (update state :stack next)]\n          (recur (invoke (after interceptor) state after interceptor)))\n\n        :else state))))\n\n(defn ^:no-doc wrap-action-handler [f ctx]\n  (assoc ctx :actions (apply f (:state ctx) (next (:action ctx)))))\n\n(defn interpolate-1 [{:nexus/keys [placeholders]} dispatch-data action]\n  (let [interpolated\n        (walk/postwalk\n         (fn [x]\n           (if-let [f (when (vector? x)\n                        (get placeholders (first x)))]\n             (apply f dispatch-data (next x))\n             x))\n         action)]\n    (cond-> interpolated\n      (not= interpolated action) (with-meta {:nexus/action action}))))\n\n(defn ^:no-doc expand-action [nexus state [kind :as action] {:keys [dispatch-data errors]}]\n  (let [action (interpolate-1 nexus dispatch-data action)]\n    (if-let [f (get-in nexus [:nexus/actions kind])]\n      (let [{:keys [action actions errors]}\n            (run-interceptors (cond-> {:state state :action action}\n                                errors (assoc :errors errors))\n              (conj (vec (:nexus/interceptors nexus))\n                    {:phase :expand-action\n                     :before-action (partial wrap-action-handler f)})\n              [:before-action :after-action :action])\n            acc (cond-> {}\n                  (seq errors) (assoc :errors errors))]\n        (cond\n          (nil? actions) acc\n\n          (not (actions? actions))\n          {:errors [{:action action\n                     :phase :expand-action\n                     :err (ex-info (str (first action) \" should expand to a collection of actions\")\n                                   {:res actions})}]}\n\n          (= actions [action])\n          (cond-> acc\n            (seq actions) (assoc :actions actions))\n\n          :else\n          (reduce (fn [res action]\n                    (let [{:keys [errors actions]} (expand-action nexus state action {:dispatch-data dispatch-data\n                                                                                      :errors (:errors res)})]\n                      (cond-> res\n                        (seq errors) (update :errors intov errors)\n                        (seq actions) (update :actions intov actions))))\n                  acc actions)))\n      {:actions [action]})))\n\n(defn expand-actions\n  \"Loops over `actions`, and expands each action to a list of actions with\n  available implementations in `nexus`. Passes `state` to each implementation.\n  Calls every available `:before-action` interceptor before expanding and every\n  `:after-action` interceptor after. Returns a map of `{:effects :errors}`.\"\n  [nexus state actions & [dispatch-data]]\n  (reduce (fn [res action]\n            (let [{:keys [actions errors]} (expand-action nexus state action res)]\n              (cond-> res\n                (seq actions) (update :effects intov actions)\n                (seq errors) (assoc :errors errors))))\n          {:dispatch-data dispatch-data} actions))\n\n(defn interpolate\n  \"Walks `actions`, and replaces any forms matching a registered placeholder with\n  the value of calling the corresponding function with `dispatch-data`. Returns\n  interpolated `actions`.\"\n  {:arglists '[[nexus dispatch-data actions]]}\n  [nexus dispatch-data actions]\n  (mapv #(interpolate-1 nexus dispatch-data %) actions))\n\n(defn ^:no-doc get-batched-effects [nexus]\n  (->> (:nexus/effects nexus)\n       (filter (comp :nexus/batch meta val))\n       (mapv key)\n       set))\n\n(defn ^:no-doc wrap-batched-effect-handler [f ctx]\n  (assoc ctx :res (f (dissoc ctx :system :actions :effects :queue :stack)\n                     (:system ctx)\n                     (mapv next (:effects ctx)))))\n\n(defn ^:no-doc wrap-effect-handler [f ctx]\n  (assoc ctx :res (apply f (dissoc ctx :system :actions :effect :queue :stack)\n                         (:system ctx)\n                         (next (:effect ctx)))))\n\n(defn ^:no-doc execute-batch [acc nexus ctx effect-k effects k wrap-handler]\n  (if-let [f (get-in nexus [:nexus/effects effect-k])]\n    (let [v (cond-> effects\n              (= k :effect) first)\n          ret (run-interceptors (into (assoc ctx k v) (select-keys acc [:errors]))\n                (conj (vec (:nexus/interceptors nexus))\n                      {:phase :execute-effect\n                       :before-effect (partial wrap-handler f)})\n                [:before-effect :after-effect :effect])]\n      (cond-> acc\n        (:res ret) (update :results conjv (into {k v} (select-keys ret [:res])))\n        (:errors ret) (assoc :errors (:errors ret))))\n    (update acc :errors conjv\n            {:phase :execute-effect\n             :effect-k effect-k\n             :err (ex-info \"No such effect\" {:available-effects (keys (:nexus/effects nexus))})})))\n\n(defn execute\n  \"Execute `effects` one by one. Calls every `:before-effect` interceptor before\n  executing the action, and every `:after-effect` interceptor after. Returns a\n  collection of maps of `{:action :res}` where `:res` is the return value of the\n  effect implementation.\"\n  [nexus ctx effects]\n  (->> (group-by (comp (get-batched-effects nexus) first) effects)\n       (reduce\n        (fn [acc [effect-k effects]]\n          (if effect-k\n            (execute-batch acc nexus ctx effect-k effects :effects wrap-batched-effect-handler)\n            (reduce #(execute-batch %1 nexus ctx (first %2) [%2] :effect wrap-effect-handler)\n                    acc effects))) {})))\n\n(defn ^{:indent 3} dispatch [nexus system dispatch-data actions]\n  (when (:nexus/actions nexus)\n    (assert (ifn? (:nexus/system->state nexus)) \":nexus/system->state must be a function\"))\n  (let [dispatch!\n        (fn dispatch! [actions & [disp-data]]\n          (let [handler {:phase :action-dispatch\n                         :before-dispatch\n                         (fn [ctx]\n                           (let [{:keys [effects errors]} (expand-actions nexus (:state ctx) (:actions ctx) (:dispatch-data ctx))]\n                             (cond-> ctx\n                               errors (assoc :errors errors)\n                               effects (into (execute nexus (assoc (dissoc ctx :actions) :dispatch dispatch!)\n                                                      (cond->> effects\n                                                        (not= actions effects)\n                                                        (interpolate nexus (:dispatch-data ctx))))))))}]\n            (run-interceptors {:system system\n                               :state (when-let [system->state (:nexus/system->state nexus)]\n                                        (system->state system))\n                               :dispatch-data (merge dispatch-data disp-data)\n                               :actions actions}\n              (conj (vec (:nexus/interceptors nexus)) handler)\n              [:before-dispatch :after-dispatch])))]\n    (select-keys (dispatch! actions) [:results :errors])))\n"],"x_google_ignoreList":[0]}